image: maven:3-jdk-14

cache:
  paths:
    - .m2/

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2"

stages:
  - test
  - build_image

test:
  stage: test
  script:
    - mvn test

build_image:
  stage: build_image
  services:
    - docker:dind
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_DRIVER: overlay2
  script:
    - mvn clean compile jib:build
      -Djib.to.auth.username=$CI_REGISTRY_USER
      -Djib.to.auth.password=$CI_REGISTRY_PASSWORD
      -Djib.to.tags=$CI_COMMIT_SHORT_SHA,latest
